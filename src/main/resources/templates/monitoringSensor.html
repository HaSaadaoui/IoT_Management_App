<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title th:text="'Sensor Monitoring - ' + ${sensor.idSensor}">Sensor Monitoring</title>
    <link rel="stylesheet" href="/css/styles.css"/>
    <link rel="stylesheet" type="text/css" th:href="@{/css/header.css}"/>
    <link rel="stylesheet" href="/css/monitoringSensor.css"/>


    <script th:inline="javascript">
        document.documentElement.dataset.deviceId  = /*[[${sensor.idSensor}]]*/ '';
        document.documentElement.dataset.gatewayId = /*[[${sensor.idGateway}]]*/ '';
        document.documentElement.dataset.devType   = /*[[${sensor.deviceType}]]*/ '';
        document.documentElement.dataset.sseToken  = /*[[${sseToken}]]*/ '';
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="/javascript/monitoringSensor.js" defer></script>
</head>

<body data-page="monitoringSensor">
<header class="app-header">
    <a href="javascript:history.back()" class="back-btn" title="Back to list" style="margin-right: 20px">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 30 30" width="30" height="30" role="img"
             aria-label="Flèche arrière violette">
            <circle cx="15" cy="15" r="13" fill="none" stroke="#662179" stroke-width="2"/>
            <path d="M17 9 L11 15 L17 21" fill="none" stroke="#662179" stroke-width="2" stroke-linecap="round"
                  stroke-linejoin="round"/>
            <line x1="11" y1="15" x2="22" y2="15" stroke="#662179" stroke-width="2" stroke-linecap="round"/>
        </svg>
    </a>
    <div class="header-title-gateway">
        <span id="sensorDeviceId" th:text="${sensor.idSensor}">--</span>
    </div>
    <div class="header-right">
        <div class="header-user">
            <a th:href="@{/users/{username}(username=${loggedUsername})}" class="header-link">
                <img th:src="${user.icon}"
                     class="header-avatar"
                     alt="User Avatar"
                     width="32" height="32">
            </a>
        </div>
    </div>
</header>

<main>

    <!-- Onglets -->
    <nav class="tabs">
        <button class="tab-btn is-active" data-pane="live">Temps réel</button>
        <button class="tab-btn" data-pane="history">Historique</button>
    </nav>

    <!-- ===== Panneau LIVE ===== -->
    <section id="pane-live">
        <!-- Infos statiques -->
        <section class="info-grid">
            <div class="card">
                <h4>Status</h4>
                <p>
                  <span class="badge" th:classappend="${sensor.status} ? ' badge--ok' : ' badge--off'">
                    <img th:src="${sensor.status} ? '/image/toggle_on.svg' : '/image/toggle_off.svg'" alt="Status"/>
                    <span th:text="${sensor.status} ? 'Active' : 'Inactive'">--</span>
                  </span>
                </p>
            </div>

            <div class="card"><h4>Sensor ID</h4><p th:text="${sensor.idSensor}">--</p></div>
            <div class="card"><h4>DevEUI</h4><p th:text="${sensor.devEui} ?: '--'">--</p></div>

            <div class="card">
                <h4>Gateway</h4>
                <p th:with="gid=${sensor.idGateway}, ip=${gatewayIp} ?: ''">
                    <a class="link"
                       th:href="@{|/manage-gateways/monitoring/${gid}/view?ip=${ip}|}"
                       th:text="${gatewayName} ?: ${gid}">--</a>
                </p>
            </div>

            <div class="card"><h4>Building</h4><p th:text="${sensor.buildingName} ?: '--'">--</p></div>
            <div class="card"><h4>Floor</h4><p th:text="${sensor.floor} ?: '--'">--</p></div>
        </section>

        <!-- Live data PAR TYPE -->
        <h3 class="section-title">Live data</h3>

        <!-- COUNT -->
        <section class="info-grid" th:if="${#strings.equalsIgnoreCase(sensor.deviceType,'COUNT')}">
            <div class="card"><h4 class="with-icon icon-signal">Battery</h4>
                <p><span id="s-count-batt" class="battery-badge">
                    <svg viewBox="0 0 46 24"><rect x="1" y="5" width="38" height="14" rx="3" fill="none" stroke="currentColor" stroke-width="2"/><rect x="41" y="9" width="4" height="6" rx="1" fill="currentColor"/></svg>
                    <span>--</span>
                </span></p></div>
            <div class="card"><h4>Period IN</h4><p><span id="s-count-in" class="badge">--</span></p></div>
            <div class="card"><h4>Period OUT</h4><p><span id="s-count-out" class="badge">--</span></p></div>
        </section>

        <!-- OCCUP -->
        <section class="info-grid" th:if="${#strings.equalsIgnoreCase(sensor.deviceType,'OCCUP')}">
            <div class="card"><h4>Occupancy</h4><p><span id="s-occup-presence" class="badge">--</span></p></div>
            <div class="card"><h4 class="with-icon icon-hum">Illuminance</h4><p><span id="s-occup-illum" class="badge">--</span></p></div>
            <div class="card"><h4>Battery</h4>
                <p><span id="s-occup-batt" class="battery-badge">
                    <svg viewBox="0 0 46 24"><rect x="1" y="5" width="38" height="14" rx="3" fill="none" stroke="currentColor" stroke-width="2"/><rect x="41" y="9" width="4" height="6" rx="1" fill="currentColor"/></svg>
                    <span>--</span>
                </span></p></div>
        </section>

        <!-- TEMPEX -->
        <section class="info-grid" th:if="${#strings.equalsIgnoreCase(sensor.deviceType,'TEMPEX')}">
            <div class="card"><h4 class="with-icon icon-temp">Temperature</h4><p><span id="s-tempex-temp" class="badge">--</span></p></div>
            <div class="card"><h4 class="with-icon icon-hum">Humidity</h4><p><span id="s-tempex-hum" class="badge">--</span></p></div>
        </section>

        <!-- PIR_LIGHT -->
        <section class="info-grid" th:if="${#strings.equalsIgnoreCase(sensor.deviceType,'PIR_LIGHT')}">
            <div class="card"><h4>PIR</h4><p><span id="s-pir-presence" class="badge">--</span></p></div>
            <div class="card"><h4>Daylight</h4><p><span id="s-pir-daylight" class="badge">--</span></p></div>
            <div class="card"><h4>Battery</h4>
                <p><span id="s-pir-batt" class="battery-badge">
                    <svg viewBox="0 0 46 24"><rect x="1" y="5" width="38" height="14" rx="3" fill="none" stroke="currentColor" stroke-width="2"/><rect x="41" y="9" width="4" height="6" rx="1" fill="currentColor"/></svg>
                    <span>--</span>
                </span></p></div>
        </section>

        <!-- DESK -->
        <section class="info-grid" th:if="${#strings.equalsIgnoreCase(sensor.deviceType,'DESK')}">
            <div class="card"><h4>👤 Occupancy</h4><p><span id="s-desk-occupancy" class="badge">--</span></p></div>
            <div class="card"><h4 class="with-icon icon-temp">Temperature</h4><p><span id="s-desk-temp" class="temp-badge temp--normal">--</span></p></div>
            <div class="card"><h4 class="with-icon icon-hum">Humidity</h4><p><span id="s-desk-hum" class="badge">-- %</span></p></div>
            <div class="card"><h4>Battery</h4>
                <p><span id="s-desk-vdd" class="battery-badge">
                    <svg viewBox="0 0 46 24"><rect x="1" y="5" width="38" height="14" rx="3" fill="none" stroke="currentColor" stroke-width="2"/><rect x="41" y="9" width="4" height="6" rx="1" fill="currentColor"/></svg>
                    <span>--</span>
                </span></p></div>
        </section>

        <!-- CO2 -->
        <section class="info-grid" th:if="${#strings.equalsIgnoreCase(sensor.deviceType,'CO2')}">
            <div class="card" style="grid-column: span 2;">
                <h4>💨 CO₂ Level</h4>
                <p><span id="s-co2-ppm" class="co2-badge co2--good">-- ppm</span></p>
            </div>
            <div class="card"><h4 class="with-icon icon-temp">Temperature</h4><p><span id="s-co2-temp" class="temp-badge temp--normal">--</span></p></div>
            <div class="card"><h4 class="with-icon icon-hum">Humidity</h4><p><span id="s-co2-hum" class="badge">--</span></p></div>
            <div class="card"><h4>Battery</h4>
                <p><span id="s-co2-vdd" class="battery-badge">
                    <svg viewBox="0 0 46 24"><rect x="1" y="5" width="38" height="14" rx="3" fill="none" stroke="currentColor" stroke-width="2"/><rect x="41" y="9" width="4" height="6" rx="1" fill="currentColor"/></svg>
                    <span>--</span>
                </span></p></div>
            <div class="card"><h4>💡 Light</h4><p><span id="s-co2-light" class="badge">--</span></p></div>
            <div class="card"><h4>👤 Motion</h4><p><span id="s-co2-motion" class="badge">--</span></p></div>
        </section>

        <!-- SON -->
        <section class="info-grid" th:if="${#strings.equalsIgnoreCase(sensor.deviceType,'SON')}">
            <div class="card"><h4>LAeq</h4><p><span id="s-sound-laeq" class="badge">--</span></p></div>
            <div class="card"><h4>LAI</h4><p><span id="s-sound-lai" class="badge">--</span></p></div>
            <div class="card"><h4>LAImax</h4><p><span id="s-sound-laimax" class="badge">--</span></p></div>
            <div class="card"><h4>Battery</h4>
                <p><span id="s-sound-batt" class="battery-badge">
                    <svg viewBox="0 0 46 24"><rect x="1" y="5" width="38" height="14" rx="3" fill="none" stroke="currentColor" stroke-width="2"/><rect x="41" y="9" width="4" height="6" rx="1" fill="currentColor"/></svg>
                    <span>--</span>
                </span></p></div>
        </section>

        <!-- EYE -->
        <section class="info-grid" th:if="${#strings.equalsIgnoreCase(sensor.deviceType,'EYE')}">
            <div class="card"><h4 class="with-icon icon-temp">Temperature</h4><p><span id="s-eye-temp" class="badge">--</span></p></div>
            <div class="card"><h4 class="with-icon icon-hum">Humidity</h4><p><span id="s-eye-hum" class="badge">--</span></p></div>
            <div class="card"><h4>Light</h4><p><span id="s-eye-light" class="badge">--</span></p></div>
            <div class="card"><h4>Presence</h4><p><span id="s-eye-presence" class="badge">--</span></p></div>
            <div class="card"><h4>Battery</h4>
                <p><span id="s-eye-vdd" class="battery-badge">
                    <svg viewBox="0 0 46 24"><rect x="1" y="5" width="38" height="14" rx="3" fill="none" stroke="currentColor" stroke-width="2"/><rect x="41" y="9" width="4" height="6" rx="1" fill="currentColor"/></svg>
                    <span>--</span>
                </span></p></div>
        </section>

        <!-- GENERIC -->
        <section class="info-grid" th:if="${!(#strings.equalsIgnoreCase(sensor.deviceType,'COUNT')
          or #strings.equalsIgnoreCase(sensor.deviceType,'OCCUP')
          or #strings.equalsIgnoreCase(sensor.deviceType,'PIR_LIGHT')
          or #strings.equalsIgnoreCase(sensor.deviceType,'DESK')
          or #strings.equalsIgnoreCase(sensor.deviceType,'CO2')
          or #strings.equalsIgnoreCase(sensor.deviceType,'TEMPEX'))}">
            <div class="card"><h4>Battery</h4>
                <p><span id="s-gen-batt" class="battery-badge">
                    <svg viewBox="0 0 46 24"><rect x="1" y="5" width="38" height="14" rx="3" fill="none" stroke="currentColor" stroke-width="2"/><rect x="41" y="9" width="4" height="6" rx="1" fill="currentColor"/></svg>
                    <span>--</span>
                </span></p></div>
        </section>

        <!-- Réseau / Radio -->
        <h3 class="section-title">Network / Radio</h3>
        <section id="net-grid" class="info-grid">
            <div class="card"><h4>Last seen</h4><p><span id="s-last" class="badge">--</span></p></div>
            <div class="card"><h4>Frequency Plan</h4><p th:text="${sensor.frequencyPlan} ?: '--'">--</p></div>
            <div class="card"><h4>f_cnt / f_port</h4><p><span id="s-fcnt" class="badge">--</span> / <span id="s-fport" class="badge">--</span></p></div>
            <div class="card"><h4 class="with-icon icon-signal">RSSI / SNR</h4><p><span id="s-rssi" class="badge">--</span> / <span id="s-snr" class="badge">--</span></p></div>
            <div class="card"><h4>SF / BW / Freq</h4><p><span id="s-dr" class="badge">--</span></p></div>
        </section>
    </section>

    <!-- ===== Panneau HISTORIQUE ===== -->
    <section id="pane-history" class="hidden">
        <h3 class="section-title">📊 Historique & Analyse</h3>

        <!-- Filtres de période -->
        <div class="history-filters card">
            <div class="filter-grid">
                <div class="filter-item">
                    <label for="hist-from">📅 Date de début</label>
                    <input type="datetime-local" id="hist-from">
                </div>
                <div class="filter-item">
                    <label for="hist-to">📅 Date de fin</label>
                    <input type="datetime-local" id="hist-to">
                </div>
                <div class="filter-item" style="align-self:end;">
                    <button id="hist-load" class="btn btn-primary">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="margin-right: 0.5rem;">
                            <path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zm3.5 7.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H11.5z"/>
                        </svg>
                        Charger les données
                    </button>
                </div>
            </div>
        </div>

        <!-- KPI Cards - Statistiques clés -->
        <div class="kpi-grid">
            <div class="kpi-card kpi-card--primary">
                <div class="kpi-icon">📊</div>
                <div class="kpi-content">
                    <div class="kpi-label">Total de mesures</div>
                    <div class="kpi-value" id="kpi-total">--</div>
                </div>
            </div>
            <div class="kpi-card kpi-card--success">
                <div class="kpi-icon">🔋</div>
                <div class="kpi-content">
                    <div class="kpi-label">Batterie moyenne</div>
                    <div class="kpi-value" id="kpi-battery">--</div>
                </div>
            </div>
            <div class="kpi-card kpi-card--info">
                <div class="kpi-icon">📡</div>
                <div class="kpi-content">
                    <div class="kpi-label">Signal moyen (RSSI)</div>
                    <div class="kpi-value" id="kpi-rssi">--</div>
                </div>
            </div>
            <div class="kpi-card kpi-card--warning">
                <div class="kpi-icon">⏱️</div>
                <div class="kpi-content">
                    <div class="kpi-label">Période analysée</div>
                    <div class="kpi-value" id="kpi-period">--</div>
                </div>
            </div>
        </div>

        <!-- Graphiques principaux -->
        <div class="charts-section">
            <h4 class="subsection-title">📈 Évolution temporelle</h4>
            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">
                            <span class="chart-icon" style="background: linear-gradient(135deg, #10b981, #059669);">🔋</span>
                            <span>Niveau de batterie</span>
                        </div>
                        <div class="chart-legend">
                            <span class="legend-item legend-good">Bon</span>
                            <span class="legend-item legend-warn">Moyen</span>
                            <span class="legend-item legend-low">Faible</span>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="histBattery"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">
                            <span class="chart-icon" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">📡</span>
                            <span>Qualité du signal (RSSI)</span>
                        </div>
                        <div class="chart-info">dBm</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="histRssi"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">
                            <span class="chart-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">📶</span>
                            <span>Rapport signal/bruit (SNR)</span>
                        </div>
                        <div class="chart-info">dB</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="histSnr"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Métriques spécifiques au capteur -->
        <div class="charts-section" id="sensor-metrics-section">
            <h4 class="subsection-title">🎯 Métriques du capteur</h4>
            <div class="charts-grid charts-grid--2col">
                <div class="chart-card" id="histMetricA-wrap">
                    <div class="chart-header">
                        <div class="chart-title">
                            <span class="chart-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">📊</span>
                            <span id="histMetricA-title">Métrique A</span>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="histMetricA"></canvas>
                    </div>
                </div>

                <div class="chart-card" id="histMetricB-wrap">
                    <div class="chart-header">
                        <div class="chart-title">
                            <span class="chart-icon" style="background: linear-gradient(135deg, #ec4899, #db2777);">📊</span>
                            <span id="histMetricB-title">Métrique B</span>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="histMetricB"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </section>

</main>
</body>
</html>
