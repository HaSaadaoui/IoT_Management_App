<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>My Profile</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/styles.css}"/>
    <link rel="stylesheet" type="text/css" th:href="@{/css/profile.css}"/>
</head>
<body>
<div th:replace="fragments/header :: appHeader(pageTitle='My profile', homeUrl=@{/})"></div>
<div class="profile-container">
    <div class="profile-box">
        <img src="/image/mantu-logo.jpg" alt="Logo" class="mantu-logo">
        <h2>My Profile</h2>

        <div class="profile-info">
            <p><strong>Username:</strong> <span th:text="${user.username}"></span></p>
            <p><strong>Firstname:</strong> <span th:text="${user.firstname}"></span></p>
            <p><strong>Lastname:</strong> <span th:text="${user.lastname}"></span></p>
            <p><strong>Email:</strong> <span th:text="${user.email}"></span></p>
            <p><strong>Role:</strong> <span th:text="${user.role}"></span></p>
        </div>

        <div class="profile-actions">
            <div th:if="${user.username == loggedUsername}" class="button-container">
                <!-- Bouton changer mot de passe -->
                <button onclick="openModal()" class="btn-change-password">
                    Change password
                </button>

                <!-- Bouton éditer user -->
                <button onclick="openEditModal()" class="btn-edit-user">
                    Update my details
                </button>
            </div>
        </div>
        <p class="success-message" th:if="${success}" th:text="${success}"></p>
    </div>
</div>
<!-- Modal pour changement de mot de passe -->
<div id="passwordModal"
     class="modal"
     th:classappend="(${errorCurrent != null} or ${errorNew != null} or ${errorConfirm != null} or ${globalError != null}) ? ' show' : ''">
    <div class="modal-content">
        <h3>Change password</h3>
        <form id="passwordForm"
              th:action="@{/users/{username}/change-password(username=${user.username})}"
              method="post">
            <label>Current password</label>
            <input type="password" name="currentPassword" required>
            <p class="error-message" th:if="${errorCurrent}" th:text="${errorCurrent}"></p>

            <label>New password</label>
            <input type="password" name="newPassword" required minlength="8">
            <p class="error-message" th:if="${errorNew}" th:text="${errorNew}"></p>

            <label>Confirm new password</label>
            <input type="password" name="confirmPassword" required>
            <p class="error-message" th:if="${errorConfirm}" th:text="${errorConfirm}"></p>

            <p class="error-message" th:if="${globalError}" th:text="${globalError}"></p>

            <div style="margin-top: 10px;">
                <button type="submit">Udpate</button>
                <button type="button" onclick="closeModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal pour édition des informations -->
<div id="editUserModal"
     class="modal"
     th:classappend="(${errorEdit != null}) ? ' show' : ''">
    <div class="modal-content">
        <h3>Update my details</h3>
        <form id="editUserForm"
              th:action="@{/users/{username}/edit(username=${user.username})}"
              method="post">

            <label>Firstname</label>
            <input type="text" name="firstname" th:value="${user.firstname}" required>

            <label>Lastname</label>
            <input type="text" name="lastname" th:value="${user.lastname}" required>

            <label>Email</label>
            <input type="email" name="email" th:value="${user.email}" required>

            <p class="error-message" th:if="${errorEdit}" th:text="${errorEdit}"></p>
            <p class="success-message" th:if="${successEdit}" th:text="${successEdit}"></p>

            <div style="margin-top: 10px;">
                <button type="submit">Udapte</button>
                <button type="button" onclick="closeEditModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
    const passwordModal = document.getElementById("passwordModal");
    const editUserModal = document.getElementById("editUserModal");

    function openModal() {
        passwordModal.style.display = "flex";
    }
    function closeModal() {
        passwordModal.style.display = "none";
    }

    function openEditModal() {
        editUserModal.style.display = "flex";
    }
    function closeEditModal() {
        editUserModal.style.display = "none";
    }

    window.onclick = function(event) {
        if (event.target === passwordModal) {
            closeModal();
        }
        if (event.target === editUserModal) {
            closeEditModal();
        }
    }
</script>
</body>
</html>
