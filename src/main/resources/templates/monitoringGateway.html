<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Gateway Monitoring</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/styles.css}"/>
    <link rel="stylesheet" type="text/css" th:href="@{/css/header.css}" />
    <link rel="stylesheet" href="/css/monitoringGateway.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.0/dist/chart.umd.min.js"></script>
</head>

<body>
<header class="app-header">
    <div class="dropdown">
        <!-- Bouton pour ouvrir le menu -->
        <button onclick="toggleMenu()" class="menu-btn" aria-label="Menu">
            <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="#662179" viewBox="0 0 24 24">
                <path d="M3 6h18M3 12h18M3 18h18" stroke="#662179" stroke-width="2" stroke-linecap="round"/>
            </svg>
        </button>

        <!-- Menu déroulant -->
        <div id="dropdownMenu" class="dropdown-content">

            <!-- Home -->
            <a th:href="@{/home}">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                     width="22" height="22" aria-hidden="true"
                     class="icon-home">
                    <path fill="#662179"
                          d="M12 3.172 2.293 12.88a1 1 0 1 0 1.414 1.414L5 13.001V20a2 2 0 0 0 2 2h3a1 1 0 0 0 1-1v-5h2v5a1 1 0 0 0 1 1h3a2 2 0 0 0 2-2v-6.999l1.293 1.293a1 1 0 0 0 1.414-1.414L12 3.172z"/>
                </svg>
                Home
            </a>

            <!-- Account -->
            <a th:href="@{/users/{username}(username=${loggedUsername})}">
                <svg xmlns="http://www.w3.org/2000/svg" height="22" viewBox="0 -960 960 960" width="22" >
                    <path fill="#662179" d="M400-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47ZM80-160v-112q0-33 17-62t47-44q51-26 115-44t141-18h14q6 0 12 2-8 18-13.5 37.5T404-360h-4q-71 0-127.5 18T180-306q-9 5-14.5 14t-5.5 20v32h252q6 21 16 41.5t22 38.5H80Zm560 40-12-60q-12-5-22.5-10.5T584-204l-58 18-40-68 46-40q-2-14-2-26t2-26l-46-40 40-68 58 18q11-8 21.5-13.5T628-460l12-60h80l12 60q12 5 22.5 11t21.5 15l58-20 40 70-46 40q2 12 2 25t-2 25l46 40-40 68-58-18q-11 8-21.5 13.5T732-180l-12 60h-80Zm40-120q33 0 56.5-23.5T760-320q0-33-23.5-56.5T680-400q-33 0-56.5 23.5T600-320q0 33 23.5 56.5T680-240ZM400-560q33 0 56.5-23.5T480-640q0-33-23.5-56.5T400-720q-33 0-56.5 23.5T320-640q0 33 23.5 56.5T400-560Zm0-80Zm12 400Z"/>
                </svg>

                Account
            </a>

            <!-- Logout -->
            <form th:action="@{/logout}" method="post" class="logout-form" style="margin:0;">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button type="submit" class="logout-link">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 96 96" width="22" height="22" fill="#662179">
                        <path d="M 2.174 2.314 C 0.018 4.610, 0 4.949, 0 44.140 L 0 83.651 2.250 85.699 C 4.901 88.111, 28.126 96, 32.577 96 C 36.811 96, 40 92.427, 40 87.686 L 40 84 48.050 84 C 62.336 84, 64.223 81.596, 63.785 63.959 L 63.500 52.500 61 52.500 C 58.510 52.500, 58.498 52.544, 58 63.834 C 57.397 77.497, 57 78, 46.809 78 L 40 78 40 45.174 C 40 12.406, 39.996 12.345, 37.750 10.302 C 36.513 9.176, 34.150 7.783, 32.500 7.206 C 30.082 6.361, 31.839 6.143, 41.559 6.079 C 57.716 5.973, 57.360 5.669, 58 20.166 C 58.498 31.456, 58.510 31.500, 61 31.500 L 63.500 31.500 63.785 20.041 C 63.962 12.888, 63.628 7.515, 62.894 5.744 C 60.667 0.367, 58.579 -0, 30.224 0 C 4.470 0, 4.338 0.011, 2.174 2.314 M 7.095 7.305 C 5.842 8.558, 5.527 78.748, 6.765 80.596 C 7.169 81.199, 12.970 83.514, 19.655 85.741 C 28.459 88.673, 32.113 89.487, 32.905 88.695 C 34.158 87.442, 34.473 17.252, 33.235 15.404 C 32.831 14.801, 27.030 12.486, 20.345 10.259 C 11.541 7.327, 7.887 6.513, 7.095 7.305 M 75.667 24.667 C 74.049 26.284, 75.348 28.918, 80.041 33.538 L 85.083 38.500 68.791 39 L 52.500 39.500 52.500 42 L 52.500 44.500 68.940 44.776 L 85.381 45.051 80.094 50.405 C 74.652 55.915, 73.730 59.132, 77.392 59.837 C 79.568 60.256, 96 44.506, 96 42 C 96 39.981, 79.926 24, 77.896 24 C 77.036 24, 76.033 24.300, 75.667 24.667"/>
                    </svg>
                    Logout
                </button>
            </form>
        </div>
    </div>
    <div class="header-title-gateway">
        <span>--[[${gatewayName}]]</span>
    </div>
</header>
<main>
    <section class="info-grid">
        <div class="card">
            <h4>Status</h4>
            <p><span id="gateway-status-badge" class="badge"><img src="/image/toggle_on.svg" alt="Status"/>--</span></p>
        </div>
        <div class="card"><h4>CPU Température</h4>
            <p><span id="cpu-temp-badge" class="badge"><img src="/image/thermostat.svg" alt="Temp"/><span id="cpu-temp">--</span></span></p>
        </div>
        <div class="card"><h4>Number of sensors connected</h4>
            <p><span id="num-sensors-badge" class="badge"><img src="/image/sensor-icon.svg" alt="Sensors"/>--</span></p>
        </div>
        <div class="card"><h4>Gateway ID</h4>
            <p id="gateway-id">--</p>
        </div>
        <div class="card"><h4>Created at</h4>
            <p id="createdAt">--</p>
        </div>
        <div class="card"><h4>Uptime Days</h4>
            <p id="uptimeDays">--</p>
        </div>
        <div class="card"><h4>IP Locale</h4>
            <p id="ipLocal">--</p>
        </div>
        <div class="card"><h4>IP Publique</h4>
            <p id="ipPublic">--</p>
        </div>
        <!--            <div class="card"><h4>Location</h4><p>Bât A - Étage 2</p></div>-->
        <!--            <div class="card"><h4>Location</h4><p id="gateway-location">&#45;&#45;</p></div>-->
        <!--            <div class="card"><h4>Hard drive</h4><p id="hardDrive">&#45;&#45;</p></div>-->
    </section>

    <section class="chart-grid">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h4>RAM Usage</h4>
                <h4 id="ramTotal" style="font-weight:normal;">--</h4>
            </div>
            <canvas id="ramChart"></canvas>
        </div>
        <div class="card">
            <h4>CPU Usage</h4>
            <canvas id="cpuChart"></canvas>
        </div>
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h4>Hard drive Usage</h4>
                <h4 id="hardDrive" style="font-weight:normal;">--</h4>
            </div>
            <canvas id="harddriveChart"></canvas>
        </div>
    </section>

    <section id="dashboard" style="display: flex; gap: 20px;">
        <div id="sensorsTable" style="flex: 1;">
            <div class="card">
                <h4>Connected Sensors</h4>
                <div id="table-container">
                    <table>
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Application</th>
                            <th>Status</th>
                        </tr>
                        </thead>
                        <tbody id="sensors-tbody">
                        <!-- tableau dynamique de capteurs -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="card" id="mapContainer" style="flex: 1; padding: 10px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h4>Gateway Location</h4>
                <h4 id="gateway-location" style="font-weight:normal;">--</h4>
            </div>
            <br>
            <div id="map" style="min-height:300px; height:50vh; width:100%; border-radius:10px;"></div>
        </div>
    </section>

    <div style="margin-top:20px;">
        <a href="/manage-gateways" class="btn">← Back to list</a>
    </div>
</main>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="/javascript/monitoringGateway.js"></script>
<script th:inline="javascript">
    const gatewayId = /*[[${gatewayId}]]*/ null;
    const gatewayIp = /*[[${ipAddress}]]*/ null;

    function toggleMenu() {
        document.getElementById("dropdownMenu").classList.toggle("show");
    }

    window.onclick = function(event) {
        if (!event.target.closest('.dropdown')) {
            document.getElementById("dropdownMenu").classList.remove("show");
        }
    }

    const eventSource = new EventSource(
        `/manage-gateways/monitoring/${encodeURIComponent(gatewayId)}/stream?ip=${encodeURIComponent(gatewayIp)}&t=${Date.now()}`
    );

    eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);

        if (data.gateway_info && data.gateway_info.name) {
            document.querySelector("header").textContent = data.gateway_info.name;
        }

        const statusBadge = document.querySelector("#gateway-status-badge");
        if (statusBadge && data.system.gateway_status) {
            statusBadge.textContent = data.system.gateway_status.charAt(0).toUpperCase() + data.system.gateway_status.slice(1);

            let imgSrc = "/image/toggle_off.svg";
            let bgColor = "red";
            if (data.system.gateway_status.toLowerCase() === "activating" || data.system.gateway_status.toLowerCase() === "active") {
                imgSrc = "/image/toggle_on.svg";
                bgColor = "green";
            }
            statusBadge.innerHTML = `<img src="${imgSrc}" alt="Status" /> ${statusBadge.textContent}`;
            statusBadge.style.backgroundColor = bgColor;
        }

        document.querySelector("#cpu-temp").textContent = `${data.system['cpu_temp (C)']} °C`;

        const sensorsBadge = document.querySelector("#num-sensors-badge");
        if (sensorsBadge && data.devices) {
            const count = data.devices.length;
            sensorsBadge.innerHTML = `<img src="/image/sensor-icon.svg" alt="Sensors" />${count}`;
            sensorsBadge.style.backgroundColor = count > 0 ? 'green' : 'gray';
        }

        if (document.querySelector("#gateway-id").textContent === "--") {
            document.querySelector("#gateway-id").textContent = gatewayId;
        }

        if (document.querySelector("#createdAt").textContent === "--" &&
            data && data.gateway_info && data.gateway_info.created_at) {
            const createdAt = data.gateway_info.created_at.split('T')[0];
            document.querySelector("#createdAt").textContent = createdAt;
        }

        if (document.querySelector("#uptimeDays").textContent === "--" && data.system.uptime_days) {
            document.querySelector("#uptimeDays").textContent = data.system.uptime_days;
        }

        if (document.querySelector("#ipLocal").textContent === "--" && data.system.ip_local) {
            document.querySelector("#ipLocal").textContent = data.system.ip_local;
        }

        if (document.querySelector("#ipPublic").textContent === "--" && data.system.ip_public) {
            document.querySelector("#ipPublic").textContent = data.system.ip_public;
        }

        const locationElem = document.querySelector("#gateway-location");
        if (locationElem && data.database && data.database.location) {
            locationElem.innerHTML = `<strong style="font-family: inherit; font-weight: bold;">${data.database.location}</strong>`;
        }

        const ramTotal = data.system['ram_total_gb (GB)'];
        const ramUsed = data.system['ram_used_gb (GB)'];
        if (ramTotal && ramUsed) {
            const ramUsagePercent = (ramUsed / ramTotal) * 100;
            ramChart.data.datasets[0].data.push(ramUsagePercent);
            if (ramChart.data.datasets[0].data.length > 5) {
                ramChart.data.datasets[0].data.shift();
                ramChart.data.labels.shift();
            }
            const now = new Date();
            ramChart.data.labels.push(now.getHours() + ':' + now.getMinutes().toString().padStart(2, '0'));
            ramChart.update();
        }

        const cpuUsage = data.system['cpu_percent (%)'];
        if (cpuUsage !== undefined) {
            cpuChart.data.datasets[0].data.push(cpuUsage);
            if (cpuChart.data.datasets[0].data.length > 30) {
                cpuChart.data.datasets[0].data.shift();
                cpuChart.data.labels.shift();
            }
            const now = new Date();
            cpuChart.data.labels.push(now.getHours() + ':' + now.getMinutes().toString().padStart(2, '0'));
            cpuChart.update();
        }

        const diskUsedPercentRaw = data.system['disk_usage_percent'];
        const diskUsedPercent = diskUsedPercentRaw ? parseFloat(diskUsedPercentRaw.replace('%', '')) : undefined;
        if (diskUsedPercent !== undefined) {
            harddriveChart.data.datasets[0].data.push(diskUsedPercent);
            if (harddriveChart.data.datasets[0].data.length > 30) {
                harddriveChart.data.datasets[0].data.shift();
                harddriveChart.data.labels.shift();
            }
            const now = new Date();
            harddriveChart.data.labels.push(now.getHours() + ':' + now.getMinutes().toString().padStart(2, '0'));
            harddriveChart.update();
        }

        if (document.querySelector("#ramTotal").textContent === "--" && data.system['ram_total_gb (GB)']) {
            const ramTotalNumber = parseFloat(data.system['ram_total_gb (GB)']);
            document.querySelector("#ramTotal").innerHTML = `<strong style="font-family: inherit; font-weight: bold;">${ramTotalNumber.toFixed(2)} GB</strong>`;
        }

        if (document.querySelector("#hardDrive").textContent === "--" && data.system.disk_total) {
            const diskTotalNumber = parseFloat(data.system.disk_total);
            document.querySelector("#hardDrive").innerHTML = `<strong style="font-family: inherit; font-weight: bold;">${diskTotalNumber.toFixed(2)} GB</strong>`;
        }

        const cpuTempBadge = document.querySelector("#cpu-temp-badge");
        if (cpuTempBadge) {
            const cpuTemp = data.system['cpu_temp (C)'];
            cpuTempBadge.style.backgroundColor =
                cpuTemp <= 75 ? 'green' : (cpuTemp <= 85 ? 'orange' : 'red');
        }

        const tbody = document.querySelector("#sensors-tbody");
        if (tbody && data.devices) {
            tbody.innerHTML = "";
            data.devices.forEach(device => {
                const statusOn = true; // à remplacer si tu as un vrai champ status
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${device.device_id}</td>
                    <td>${device.application_id}</td>
                    <td>
                        <span class="badge badge-small" style="background-color:${statusOn ? 'green' : 'red'}">
                            <img src="/image/${statusOn ? 'toggle_on' : 'toggle_off'}.svg" alt="${statusOn ? 'On' : 'Off'}" />
                            ${statusOn ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        if (data.gateway_info && data.gateway_info.location && typeof gatewayMarker !== 'undefined') {
            const lat = data.gateway_info.location.latitude;
            const lon = data.gateway_info.location.longitude;
            gatewayMarker.setLatLng([lat, lon]);
            if (typeof map !== 'undefined') {
                map.setView([lat, lon], 13);
            }
        }

        console.log("Data reçue :", data);
    };

    eventSource.onerror = function(error) {
        console.error("Erreur SSE :", error);
        eventSource.close();
    };
</script>

</body>
</html>
