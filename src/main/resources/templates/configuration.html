<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Configuration</title>

    <!-- ================= STYLES ================= -->
    <!-- Styles globaux -->
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- ================= SCRIPTS ================= -->
    <!-- Bootstrap Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Ace Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.23.1/ace.js"></script>
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r152/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.152.0/examples/js/controls/OrbitControls.js"></script>

    <!-- ================= STYLES SPECIFIQUES ================= -->
    <style>
        body { background-color: #f5f4fa; font-family: 'Segoe UI', sans-serif; }
        .config-page { max-width: 1400px; margin: 30px auto; padding: 0 15px; }
        .config-card { 
            background: #ffffff; 
            padding: 25px; 
            margin-bottom: 25px; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
        }
        .config-card h2 { color: #662179; margin-bottom: 20px; font-size: 1.5em; }
        label { font-weight: 500; }
        .form-control, .form-select, textarea { border-radius: 8px; }
        .btn-violet { background-color: #662179; color: #fff; }
        .btn-violet:hover { background-color: #7f3fbf; color: #fff; }
        #payload-editor { width: 100%; height: 300px; border-radius: 8px; border: 1px solid #ccc; }
        #test-decoded { background: #f0f0f0; padding: 10px; border-radius: 8px; min-height: 50px; margin-top: 10px; }
        #three-container { width: 100%; height: 600px; border: 1px solid #ccc; border-radius: 8px; margin-top: 15px; }
        #plan2D { width: 100%; height: 400px; border: 1px solid #ccc; border-radius: 8px; margin-top: 15px; display: none; background-color:#e0e0e0; }
    </style>

    <!-- ================= SCRIPT FUNCTIONS ================= -->
    <script>
        // ================= VARIABLES THREE.JS =================
        let scene, camera, renderer, controls, raycaster, mouse, selectedObject;
    // ================= CODE PAR DEFAUT DU PAYLOAD =================
            const defaultPayloadCode = `
        var TYPE_TEMP         = 0x01; 
        var TYPE_RH           = 0x02;
        var TYPE_CO2          = 0x06; 
        var TYPE_VDD          = 0x07; 
        var TYPE_OCCUPANCY    = 0x11;

        function bin16dec(bin) {
            var num = bin & 0xFFFF;
            if (0x8000 & num) num = - (0x010000 - num);
            return num;
        }

        function decodePayload(bytes){
            var obj = {};
            for(let i=0; i<bytes.length; i++){
                switch(bytes[i]){
                    case TYPE_TEMP: 
                        var temp=(bytes[i+1]<<8)|(bytes[i+2]);
                        temp=bin16dec(temp);
                        obj.temperature=temp/10;
                        i+=2;
                        break;
                    case TYPE_RH: 
                        obj.humidity=bytes[i+1];
                        i+=1;
                        break;
                    case TYPE_VDD:
                        obj.vdd=(bytes[i+1]<<8)|(bytes[i+2]);
                        i+=2;
                        break;
                    case TYPE_OCCUPANCY:
                        obj.occupancy=bytes[i+1];
                        i+=1;
                        break;
                    default:
                        i=bytes.length;
                        break;
                }
            }
            return obj;
        }`;
        // ================= FONCTIONS DE 3D =================
        function addDesk(x, y, z) {
            const geometry = new THREE.BoxGeometry(2,1,1);
            const material = new THREE.MeshStandardMaterial({color:0x662179});
            const desk = new THREE.Mesh(geometry, material);
            desk.position.set(x, y, z);
            desk.userData.type = "desk";
            scene.add(desk);
        }

        function onPointerDown(event) {
            const rect = renderer.domElement.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left)/rect.width)*2-1;
            mouse.y = -((event.clientY - rect.top)/rect.height)*2+1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(scene.children);
            if(intersects.length>0 && intersects[0].object.userData.type==="desk") {
                selectedObject = intersects[0].object;
            }
        }

        function onPointerMove(event) {
            if(selectedObject) {
                const rect = renderer.domElement.getBoundingClientRect();
                mouse.x = ((event.clientX - rect.left)/rect.width)*2-1;
                mouse.y = -((event.clientY - rect.top)/rect.height)*2+1;
                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(scene.children.filter(obj => obj.name==="floor"));
                if(intersects.length>0) {
                    selectedObject.position.x = intersects[0].point.x;
                    selectedObject.position.z = intersects[0].point.z;
                }
            }
        }

        function onPointerUp(event) { selectedObject = null; }

        function animate() { requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); }

        function show3D() { document.getElementById("three-container").style.display="block"; document.getElementById("plan2D").style.display="none"; }
        function show2D() { document.getElementById("three-container").style.display="none"; document.getElementById("plan2D").style.display="block"; }

        // ================= ACE EDITOR =================
        window.onload = function() {
            const editor = ace.edit("payload-editor");
            editor.setTheme("ace/theme/monokai");
            editor.session.setMode("ace/mode/javascript");
            editor.setValue(defaultPayloadCode, -1); // -1 place le curseur au d√©but
            editor.focus();
        };

        function changeEditorLanguage(select){
            const lang = select.value.toLowerCase();
            ace.edit("payload-editor").session.setMode("ace/mode/"+lang);
        }

        // ================= DECODER SIMPLIFIE =================
        function hexToBytes(hex) {
            let bytes = [];
            for(let c=0; c<hex.length; c+=2){ bytes.push(parseInt(hex.substr(c,2),16)); }
            return bytes;
        }

        function testDecoder() {
            const hexInput = document.getElementById("test-byte-payload").value;
            if(!hexInput) return alert("Please enter a hex payload!");
            const byteArray = hexToBytes(hexInput);
            const editorCode = ace.edit("payload-editor").getValue();

            let result = {};
            try {
                const func = new Function("bytes", editorCode + "\nreturn decodePayload(bytes);");
                result = func(byteArray);
            } catch(err) { result = { error: err.message }; }

            document.getElementById("test-decoded").innerText = JSON.stringify(result,null,2);
        }

        // ================= ALERT CHANNELS =================
        function toggleChannelInput(){
            document.getElementById("channel-email").style.display = document.getElementById("alert-email").checked ? "block" : "none";
            document.getElementById("channel-phone").style.display = document.getElementById("alert-sms").checked ? "block" : "none";
        }
    </script>
</head>
<body>

<!-- ================= HEADER ================= -->
<div th:replace="fragments/header :: appHeader(pageTitle='Advanced Configuration', homeUrl=@{/})"></div>

<!-- ================= CONFIGURATION PAGE ================= -->
<div class="config-page">

    <!-- ================= SENSOR MANAGEMENT ================= -->
    <div class="config-card">
        <h2>Sensor Management</h2>
        <form>
            <div class="row mb-3">
                <div class="col-md-3">
                    <label>Sensor Type</label>
                    <select class="form-select" id="sensor-type">
                        <option>Temperature</option>
                        <option>CO2</option>
                        <option>Presence</option>
                        <option>Light</option>
                        <option selected>Occupancy</option>
                    </select>
                </div>
                <div class="col-md-3"><label>Brand</label><input type="text" class="form-control" value="Elsys"></div>
                <div class="col-md-3"><label>Decoder</label><input type="text" class="form-control" value="Custom Elsys"></div>
                <div class="col-md-3"><label>Protocol</label><input type="text" class="form-control" value="LoRaWAN"></div>
            </div>
            <div class="mb-3">
                <label>Formatter Language</label>
                <select class="form-select" id="formatter-lang" onchange="changeEditorLanguage(this)">
                    <option selected>JavaScript</option>
                    <option>Python</option>
                    <option>Java</option>
                    <option>C++</option>
                </select>
            </div>
            <div class="mb-3">
                <label>Payload Formatter</label>
                <div id="payload-editor"></div>
            </div>
            <div class="mb-3">
                <label>Test Byte Payload</label>
                <div class="input-group">
                    <input type="text" id="test-byte-payload" class="form-control" value="0100ED022D070E4D1102">
                    <button type="button" class="btn btn-violet" onclick="testDecoder()">Test Decoder</button>
                </div>
                <div id="test-decoded">Decoded result will appear here</div>
            </div>
            <button type="submit" class="btn btn-violet">Save</button>
        </form>
    </div>

    <!-- ================= ENERGY MANAGEMENT ================= -->
    <div class="config-card">
        <h2>Energy Management</h2>
        <form>
            <div class="row mb-3">
                <div class="col-md-6"><label>Management Mode</label>
                    <select class="form-select"><option>Eco</option><option>Normal</option><option>Performance</option></select>
                </div>
                <div class="col-md-6"><label>Consumption Alert Threshold</label><input type="number" class="form-control"></div>
            </div>
            <div class="mb-3"><label>Period</label>
                <select class="form-select"><option>Daily</option><option>Weekly</option><option>Monthly</option></select>
            </div>
            <button type="submit" class="btn btn-violet">Save</button>
        </form>
    </div>

    <!-- ================= Occupancy ================= -->
    <div class="config-card">
    <h2>Occupancy and Space Usage</h2>
    <form>
    <div class="row mb-3">
        <div class="col-md-6"><label>Building Zone</label><input type="text" class="form-control"></div>
        <div class="col-md-6"><label>Presence Alert Threshold</label><input type="number" class="form-control"></div>
    </div>
    <div class="mb-3"><label>Period</label><select class="form-select"><option>Daily</option><option>Weekly</option><option>Monthly</option></select></div>
    <button type="submit" class="btn btn-violet">Save</button>
    </form>
    </div>

    <!-- ================= Alerts ================= -->
    <div class="config-card">
    <h2>Alerts and Notifications</h2>
    <form>
    <div class="mb-3">
        <label>Parameter to Monitor</label>
        <select class="form-select"><option>Temperature</option><option>Humidity</option><option>CO2</option><option>Noise Level</option></select>
    </div>
    <div class="mb-3">
        <label>Channels</label><br>
        <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="alert-email" onclick="toggleChannelInput()"><label>Email</label></div>
        <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="alert-sms" onclick="toggleChannelInput()"><label>Phone</label></div>
    </div>
    <div id="channel-email" style="display:none;" class="mb-3"><label>Email(s)</label><input type="email" class="form-control"></div>
    <div id="channel-phone" style="display:none;" class="mb-3"><label>Phone Number(s)</label><input type="text" class="form-control"></div>
    <button type="submit" class="btn btn-violet">Save</button>
    </form>
    </div>
    <!-- ================= Building Modeling ================= -->

    <div class="config-card">
    <h2>Building Modeling</h2>
    <form>
    <div class="row mb-3">
        <div class="col-md-4"><label>Building Name</label><input type="text" class="form-control"></div>
        <div class="col-md-4"><label>Number of Floors</label><input type="number" class="form-control"></div>
        <div class="col-md-4"><label>Address</label><input type="text" class="form-control"></div>
    </div>
    <div class="mb-3"><label>Building Plan (PDF or image)</label><input type="file" class="form-control"></div>
    <div class="mt-2">
        <button type="button" class="btn btn-violet" onclick="show3D()">Generate 3D</button>
        <button type="button" class="btn btn-violet" onclick="show2D()">Generate 2D</button>
    </div>
    <div id="three-container"></div>
    <div id="plan2D"></div>
    <div class="mt-3"><button type="submit" class="btn btn-violet">Save</button></div>
    </form>
    </div>

</div>
</body>
</html>
